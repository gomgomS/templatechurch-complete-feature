{% extends "admin/base.html" %}

{% block title %}Web Control{% endblock %}

{% block page_heading %}Web Control{% endblock %}

{% block extra_head %}
<!-- Frontend CSS for preview matching -->
<link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="{{ url_for('static', filename='src/css/bootstrap.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='src/css/styles.css') }}" />
<!-- Shared Quill Preview Match CSS - Ensures editor preview matches frontend exactly -->
<link rel="stylesheet" href="{{ url_for('static', filename='src/css/quill-preview-match.css') }}" />
<style>
    /* Admin-specific styles (not related to Quill preview matching) */
    .card-body {
        padding: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    /* Better spacing for existing items */
    .list-group-item {
        transition: background-color 0.2s ease;
    }
    
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    /* Button improvements */
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
    
    /* Card header improvements */
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    
    /* Form input improvements */
    .form-control {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* Gap utility for flex items */
    .gap-2 {
        gap: 0.5rem;
    }

    /* ===============================
       Right Sidebar Drawer for Existing Items
       =============================== */
    #existingItemsSection {
        position: fixed;
        top: 80px; /* below topbar */
        right: 0;
        width: 420px;
        max-width: 100%;
        height: calc(100vh - 90px);
        z-index: 1040;
        transform: translateX(100%);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: none;
        pointer-events: none; /* prevent clicks when hidden */
    }

    #existingItemsSection.drawer-open {
        transform: translateX(0);
        box-shadow: -4px 0 16px rgba(0, 0, 0, 0.15);
        pointer-events: auto;
    }

    /* Make card fit content inside drawer */
    #existingItemsSection .card {
        max-height: 100%;
        border-radius: 0;
        border-left: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
    }

    #existingItemsSection .card-body {
        max-height: calc(100vh - 200px); /* account for card-header and spacing */
        overflow-y: auto;
        flex: 0 1 auto;
    }

    /* Floating toggle button on right edge */
    .drawer-toggle-btn {
        position: fixed;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        z-index: 1050;
        border-radius: 30px 0 0 30px;
        box-shadow: -2px 2px 8px rgba(0,0,0,0.2);
        padding: 0.5rem 0.75rem;
    }

    .drawer-toggle-btn i {
        transition: transform 0.3s ease;
    }

    .drawer-open-icon {
        transform: rotate(180deg);
    }

    /* Edit section width adjustment based on drawer state */
    #editSection {
        transition: all 0.3s ease;
    }
    
    /* When drawer is open, edit section width = 100% - drawer width (420px) */
    .drawer-open-adjacent #editSection {
        flex: 0 0 calc(100% - 420px);
        max-width: calc(100% - 420px);
        padding-right: 0 !important;
        margin-right: 0 !important;
    }
    
    /* When drawer is closed, edit section is full width */
    .drawer-closed-adjacent #editSection {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    /* Remove gap between edit section and drawer */
    .drawer-open-adjacent {
        margin-right: 0;
        padding-right: 0;
    }
    
    /* Remove Bootstrap gutter on right side when drawer is open */
    .drawer-open-adjacent > * {
        padding-right: 0;
    }
    
    /* Remove container padding on right when drawer is open */
    .container-fluid:has(.drawer-open-adjacent),
    .container:has(.drawer-open-adjacent) {
        padding-right: 0;
    }
    
    /* Fallback for browsers without :has() support */
    .drawer-open-adjacent {
        margin-right: 0 !important;
    }
    
    /* Ensure edit section card extends to edge */
    .drawer-open-adjacent #editSection .card {
        margin-right: 0;
        border-radius: 0.375rem 0 0 0.375rem;
    }
    
    /* Ensure drawer aligns perfectly with edit section - no gap */
    #existingItemsSection.drawer-open {
        right: 0;
    }
    
    /* Remove any spacing that might create gap */
    .drawer-open-adjacent #editSection {
        margin-right: 0 !important;
    }
    
    /* File picker button styling in Quill toolbar */
    .ql-file-picker,
    .ql-file-picker-static {
        width: 28px;
        position: relative;
    }
    
    /* Hide default Quill SVG icons for custom buttons */
    .ql-file-picker svg,
    .ql-file-picker-static svg {
        display: none !important;
    }
    
    /* Style Font Awesome icons in custom buttons */
    .ql-file-picker i.fas,
    .ql-file-picker-static i.fas {
        display: inline-block !important;
        font-size: 16px;
        line-height: 1;
        vertical-align: middle;
    }
    
    /* Red color for static file picker icon */
    .ql-file-picker-static i.fas {
        color: #dc3545 !important;
    }
    
    .ql-file-picker-static:hover i.fas {
        color: #c82333 !important; /* Darker red on hover */
    }
    
    /* Ensure buttons are visible and clickable */
    .ql-file-picker button,
    .ql-file-picker-static button {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    /* File list item styling */
    .file-picker-item {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .file-picker-item:hover {
        background-color: #f8f9fa;
    }
    
    .file-picker-item.selected {
        background-color: #e7f3ff;
        border-left: 3px solid #007bff;
    }
    
    /* Sortable drag and drop styling */
    .sortable-item {
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    
    .sortable-ghost {
        opacity: 0.4;
        background-color: #e3f2fd;
    }
    
    .sortable-drag {
        opacity: 0.8;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .drag-handle {
        opacity: 0.6;
        transition: opacity 0.2s ease;
    }
    
    .sortable-item:hover .drag-handle {
        opacity: 1;
    }
    
    .sortable-chosen {
        background-color: #f8f9fa;
    }
    
    /* HTML Tag Editor styling */
    .html-editor-preview {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        background: white;
        min-height: 200px;
        max-height: 500px;
        overflow-y: auto;
    }
    
    .html-editor-preview [data-editable-tag] {
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
        outline: 1px dashed transparent;
        padding: 2px;
        margin: 1px;
    }
    
    .html-editor-preview [data-editable-tag]:hover {
        outline: 2px dashed #007bff;
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .html-editor-preview [data-editable-tag].selected {
        outline: 2px solid #28a745;
        background-color: rgba(40, 167, 69, 0.1);
    }
    
    .html-editor-preview [data-editable-tag]:hover::before {
        content: attr(data-tag-name);
        position: absolute;
        top: -20px;
        left: 0;
        background: #007bff;
        color: white;
        padding: 2px 6px;
        font-size: 10px;
        border-radius: 3px;
        z-index: 100;
        white-space: nowrap;
    }
    
    .tag-editor-panel {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        background: #f8f9fa;
        margin-top: 10px;
        display: none;
    }
    
    .tag-editor-panel.active {
        display: block;
    }
    
    .html-code-editor {
        font-family: 'Courier New', monospace;
        font-size: 13px;
    }

    @media (max-width: 767.98px) {
        #existingItemsSection {
            width: 100%;
            top: 70px;
            height: calc(100vh - 80px);
        }
        
        /* On mobile, edit section is always full width when drawer is open */
        .drawer-open-adjacent #editSection {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="row drawer-open-adjacent">
    <div class="col-lg-6" id="editSection">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-edit"></i> Add/Edit Navigation & Content
                </h6>
            </div>
            <div class="card-body">
                <form action="{{ url_for('admin_web_control_save') }}" method="POST" id="mainForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="nav_key_old" id="nav_key_old" value=""/>
                    
                    <div class="form-group">
                        <label for="nav_name">Nav Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nav_name" name="nav_name" 
                               placeholder="e.g., about, home, services" required>
                        <small class="form-text text-muted">Unique identifier (lowercase, no spaces)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="nav_label">Label <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nav_label" name="nav_label" 
                               placeholder="e.g., About, Home, Services" required>
                    </div>
                    
                    <div class="form-group">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="mb-0"><strong>Content Blocks</strong> <span class="text-danger">*</span></label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-primary" onclick="addContentBlock('content')" title="Add Quill Editor Block">
                                    <i class="fas fa-edit"></i> Add Content
                                </button>
                                <!-- Hidden: Raw HTML injection - use HTML Editor instead
                                <button type="button" class="btn btn-sm btn-info" onclick="addContentBlock('injected_html')" title="Add HTML Injection Block">
                                    <i class="fas fa-code"></i> Add HTML
                                </button>
                                -->
                                <button type="button" class="btn btn-sm btn-warning" onclick="addContentBlock('html_editor')" title="Add HTML Tag Editor Block">
                                    <i class="fas fa-tags"></i> HTML Editor
                                </button>
                                <button type="button" class="btn btn-sm btn-success" onclick="addContentBlock('maps')" title="Add Maps Block">
                                    <i class="fas fa-map-marker-alt"></i> Add Maps
                                </button>
                            </div>
                        </div>
                        <div id="contentBlocksContainer">
                            <!-- Content blocks will be dynamically added here -->
                            <p class="text-muted text-center py-3" id="noBlocksMessage">No content blocks yet. Click buttons above to add blocks.</p>
                        </div>
                        <input type="hidden" name="content_blocks" id="contentBlocksData" value="[]">
                    </div>

                    <div class="form-group mt-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableBackgroundColor" onchange="toggleBackgroundColorForm()">
                            <label class="form-check-label" for="enableBackgroundColor">
                                <i class="fas fa-palette"></i> <strong>Custom Background Color</strong>
                            </label>
                            <small class="form-text text-muted d-block">Check this to set a custom background color for this section</small>
                        </div>
                    </div>

                    <div class="card mt-3" id="backgroundColorCard" style="display: none;">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-palette"></i> Background Color Settings
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="section_background_color_text">Background</label>
                                <div class="d-flex align-items-center gap-3 flex-wrap">
                                    <input type="text" class="form-control" id="section_background_color_text" name="section_background_color"
                                           placeholder="e.g., #ffffff, red, linear-gradient(135deg,#f8fafc,#eef2ff), rgb(255,255,255)"
                                           style="flex: 1; min-width: 250px;">
                                    <input type="color" class="form-control form-control-color" id="section_background_color_picker" 
                                           value="#ffffff" style="width: 80px; height: 40px; cursor: pointer;"
                                           title="Quick color picker (for solid colors only)">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearBackgroundColor()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    Enter any CSS background value: hex colors (#ffffff), named colors (red, blue), gradients (linear-gradient(...)), rgb/rgba, etc.
                                    <br><strong>Examples:</strong> <code>#f0f0f0</code>, <code>red</code>, <code>linear-gradient(135deg,#f8fafc,#eef2ff)</code>, <code>rgb(240,240,240)</code>
                                </small>
                            </div>
                            <div class="form-group">
                                <div id="backgroundColorPreview" style="height: 80px; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #ffffff;">
                                    <span class="text-muted">Preview</span>
                                </div>
                                <small class="form-text text-muted">Preview of the selected background.</small>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <i class="fas fa-times"></i> Clear Form
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Right sidebar drawer: Existing items (open by default) -->
    <div class="col-lg-5 drawer-open" id="existingItemsSection">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-link text-primary p-0 mr-2" 
                            id="toggleExistingItems" title="Toggle Existing Items"
                            onclick="toggleExistingItemsSection()">
                        <i class="fas fa-chevron-right" id="toggleExistingItemsIcon"></i>
                    </button>
                    <h6 class="m-0 font-weight-bold text-primary" id="existingItemsTitle">
                        <i class="fas fa-list"></i> Existing Items
                    </h6>
                </div>
                <button type="button" class="btn btn-sm btn-success" id="addNewBtn" onclick="addNewSection()" title="Add New Section">
                    <i class="fas fa-plus"></i> Add New
                </button>
            </div>
            <div id="existingItemsContent">
                <div class="card-body p-0">
                    {% if navigation %}
                        <div class="list-group list-group-flush" id="sortableNavList">
                            {% for nav in navigation %}
                            <div class="list-group-item px-3 py-2 border-bottom sortable-item" data-key="{{ nav.key }}">
                                <div class="d-flex align-items-center">
                                    <div class="drag-handle mr-2" style="cursor: move;">
                                        <i class="fas fa-grip-vertical text-muted"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6 class="mb-1 font-weight-bold">{{ nav.label }}</h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-tag"></i> {{ nav.key }}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2 mt-2">
                                            <button type="button" class="btn btn-sm btn-warning edit-item-btn flex-fill" 
                                                    data-key="{{ nav.key }}"
                                                    data-label="{{ nav.label }}"
                                                    title="Edit">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <form action="{{ url_for('admin_web_control_delete_nav', nav_key=nav.key) }}" 
                                                  method="POST" style="display: inline; flex: 1;" 
                                                  class="delete-form"
                                                  data-label="{{ nav.label }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="btn btn-sm btn-danger w-100" title="Delete">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted p-3 mb-0">No items yet. Click "Add New" to create a new section.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating toggle button for right sidebar drawer -->
<button type="button"
        class="btn btn-primary drawer-toggle-btn"
        id="drawerToggleButton"
        title="Toggle Existing Items"
        onclick="toggleExistingItemsSection()">
    <i class="fas fa-list" id="drawerToggleIcon"></i>
</button>

<!-- File Picker Modal for Quill Editor -->
<div class="modal fade" id="filePickerModal" tabindex="-1" role="dialog" aria-labelledby="filePickerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filePickerModalLabel">
                    <i class="fas fa-folder" id="filePickerModalIcon"></i> <span id="filePickerModalTitle">Select File</span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-end mb-3" id="filePickerSourceToggle" style="display: none;">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="toggleDbFiles" onclick="switchFileSource('db')">
                            <i class="fas fa-database"></i> Database
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="toggleStaticFiles" onclick="switchFileSource('static')">
                            <i class="fas fa-file-code"></i> Static (JSON)
                        </button>
                    </div>
                </div>
                <div id="filePickerLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading files...</p>
                </div>
                <div id="filePickerList" style="display: none;">
                    <div class="list-group" id="fileListContainer">
                        <!-- Files will be inserted here -->
                    </div>
                </div>
                <div id="filePickerEmpty" style="display: none;" class="text-center py-4">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No files available. Upload files in the File List section.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- Quill Editor -->
<link href="{{ url_for('static', filename='lib/quill/quill.snow.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='lib/quill/quill.min.js') }}"></script>
<!-- Quill Image Resize Module -->
<script src="https://unpkg.com/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
<!-- SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script type="application/json" id="content-data">
{{ content_data|tojson|safe }}
</script>

<script type="application/json" id="navigation-data">
{{ navigation|tojson|safe }}
</script>

<script type="application/json" id="plugin-data">
{{ plugin_data|tojson|safe }}
</script>

<script type="application/json" id="injected-html-data">
{{ injected_html_data|tojson|safe }}
</script>

<script type="application/json" id="blocks-data">
{{ blocks_data|tojson|safe }}
</script>

<script>
    let contentData = {};
    let navigationData = [];
    let pluginData = {};
    let injectedHtmlData = {};
    let blocksData = {};

    // Load content data from server
    try {
        const dataScript = document.getElementById('content-data');
        if (dataScript && dataScript.textContent) {
            contentData = JSON.parse(dataScript.textContent);
        }
    } catch (e) {
        console.error('Error loading content data:', e);
        contentData = {};
    }

    // Load navigation data from server
    try {
        const navScript = document.getElementById('navigation-data');
        if (navScript && navScript.textContent) {
            navigationData = JSON.parse(navScript.textContent);
        }
    } catch (e) {
        console.error('Error loading navigation data:', e);
        navigationData = [];
    }

    // Load plugin data from server
    try {
        const pluginScript = document.getElementById('plugin-data');
        if (pluginScript && pluginScript.textContent) {
            pluginData = JSON.parse(pluginScript.textContent);
        }
    } catch (e) {
        console.error('Error loading plugin data:', e);
        pluginData = {};
    }

    // Load injected HTML data from server
    try {
        const injectedHtmlScript = document.getElementById('injected-html-data');
        if (injectedHtmlScript && injectedHtmlScript.textContent) {
            injectedHtmlData = JSON.parse(injectedHtmlScript.textContent);
        }
    } catch (e) {
        console.error('Error loading injected HTML data:', e);
        injectedHtmlData = {};
    }

    // Load blocks data from server
    try {
        const blocksScript = document.getElementById('blocks-data');
        if (blocksScript && blocksScript.textContent) {
            blocksData = JSON.parse(blocksScript.textContent);
        }
    } catch (e) {
        console.error('Error loading blocks data:', e);
        blocksData = {};
    }

    // Content blocks management
    let contentBlocks = [];
    let quillInstances = {}; // Store multiple Quill instances by block ID
    
    function addContentBlock(type) {
        // Save all block content before adding new block
        saveAllBlockContent();
        
        const blockId = 'block_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const block = {
            id: blockId,
            type: type,
            data: type === 'maps' ? { latitude: '', longitude: '' } : (type === 'html_editor' ? '' : '')
        };
        contentBlocks.push(block);
        renderContentBlocks();
        // Focus on the new block
        setTimeout(() => {
            if (type === 'content') {
                const quill = quillInstances[blockId];
                if (quill) quill.focus();
            } else if (type === 'injected_html') {
                const textarea = document.querySelector(`[data-block-id="${blockId}"] textarea`);
                if (textarea) textarea.focus();
            } else if (type === 'html_editor') {
                const textarea = document.querySelector(`[data-block-id="${blockId}"] .html-code-editor`);
                if (textarea) textarea.focus();
            }
        }, 200);
    }
    
    function removeContentBlock(blockId) {
        contentBlocks = contentBlocks.filter(b => b.id !== blockId);
        // Destroy Quill instance if exists
        if (quillInstances[blockId]) {
            delete quillInstances[blockId];
        }
        renderContentBlocks();
    }
    
    // Helper function to save all block content before re-rendering
    function saveAllBlockContent() {
        console.log('[saveAllBlockContent] Starting to save all blocks. Total blocks:', contentBlocks.length);
        contentBlocks.forEach((block, idx) => {
            console.log(`[saveAllBlockContent] Block ${idx}: id=${block.id}, type=${block.type}, data=`, block.data);
            
            if (block.type === 'content') {
                // Save Quill editor content
                if (quillInstances[block.id]) {
                    const quill = quillInstances[block.id];
                    const oldData = block.data;
                    block.data = quill.root.innerHTML;
                    console.log(`[saveAllBlockContent] Saved Quill content for block ${block.id}. Length: ${block.data.length}`);
                } else {
                    console.log(`[saveAllBlockContent] No Quill instance found for block ${block.id}, preserving existing data`);
                }
                // If Quill instance doesn't exist, preserve existing block.data (don't overwrite)
                // block.data remains unchanged
            } else if (block.type === 'injected_html') {
                // Save textarea content
                const blockDiv = document.querySelector(`[data-block-id="${block.id}"]`);
                if (blockDiv) {
                    const textarea = blockDiv.querySelector('textarea');
                    if (textarea) {
                        const oldData = block.data;
                        block.data = textarea.value;
                        console.log(`[saveAllBlockContent] Saved HTML content for block ${block.id}. Length: ${block.data.length}`);
                    } else {
                        console.log(`[saveAllBlockContent] Textarea not found in blockDiv for block ${block.id}`);
                    }
                } else {
                    console.log(`[saveAllBlockContent] BlockDiv not found for block ${block.id}, preserving existing data`);
                }
                // If textarea not found, preserve existing block.data (don't overwrite)
                // block.data remains unchanged
            } else if (block.type === 'maps') {
                // Save maps input values
                const blockDiv = document.querySelector(`[data-block-id="${block.id}"]`);
                if (blockDiv) {
                    const latInput = blockDiv.querySelector('.map-latitude-input');
                    const lngInput = blockDiv.querySelector('.map-longitude-input');
                    if (latInput && lngInput) {
                        const lat = parseFloat(latInput.value);
                        const lng = parseFloat(lngInput.value);
                        const oldData = block.data;
                        block.data = {
                            latitude: isNaN(lat) ? '' : lat,
                            longitude: isNaN(lng) ? '' : lng
                        };
                        console.log(`[saveAllBlockContent] Saved maps data for block ${block.id}:`, block.data);
                    } else {
                        console.log(`[saveAllBlockContent] Map inputs not found for block ${block.id}`);
                        // If inputs not found, preserve existing block.data structure
                        if (!block.data || typeof block.data !== 'object') {
                            block.data = { latitude: '', longitude: '' };
                        }
                    }
                } else {
                    console.log(`[saveAllBlockContent] BlockDiv not found for maps block ${block.id}, preserving existing data`);
                    // If blockDiv not found, preserve existing block.data structure
                    if (!block.data || typeof block.data !== 'object') {
                        block.data = { latitude: '', longitude: '' };
                    }
                }
            } else if (block.type === 'html_editor') {
                // Save HTML editor content (just the HTML string)
                const blockDiv = document.querySelector(`[data-block-id="${block.id}"]`);
                if (blockDiv) {
                    const htmlTextarea = blockDiv.querySelector('.html-code-editor');
                    if (htmlTextarea) {
                        block.data = htmlTextarea.value;
                        console.log(`[saveAllBlockContent] Saved HTML editor content for block ${block.id}`);
                    } else {
                        console.log(`[saveAllBlockContent] HTML textarea not found for block ${block.id}`);
                    }
                } else {
                    console.log(`[saveAllBlockContent] BlockDiv not found for html_editor block ${block.id}, preserving existing data`);
                }
            }
            
            console.log(`[saveAllBlockContent] Block ${idx} after save: id=${block.id}, type=${block.type}, data=`, block.data);
        });
        console.log('[saveAllBlockContent] Finished saving all blocks');
    }
    
    function moveBlockUp(blockId) {
        console.log('[moveBlockUp] ===== START =====');
        console.log('[moveBlockUp] Block ID to move:', blockId);
        console.log('[moveBlockUp] Current blocks before save:', JSON.parse(JSON.stringify(contentBlocks.map(b => ({id: b.id, type: b.type, hasData: !!b.data})))));
        
        // Save all block content before moving - this updates block.data for all blocks
        saveAllBlockContent();
        
        console.log('[moveBlockUp] Blocks after save:', JSON.parse(JSON.stringify(contentBlocks.map(b => ({id: b.id, type: b.type, hasData: !!b.data})))));
        
        const index = contentBlocks.findIndex(b => b.id === blockId);
        console.log('[moveBlockUp] Found block at index:', index);
        
        if (index > 0 && index < contentBlocks.length) {
            const originalLength = contentBlocks.length;
            console.log('[moveBlockUp] Original array length:', originalLength);
            console.log('[moveBlockUp] Block at index', index, ':', contentBlocks[index]);
            console.log('[moveBlockUp] Block at index', index - 1, ':', contentBlocks[index - 1]);
            
            // Create a new array with blocks in the new order to avoid any reference issues
            const newBlocks = [];
            for (let i = 0; i < contentBlocks.length; i++) {
                if (i === index - 1) {
                    // Insert current block at previous position
                    console.log(`[moveBlockUp] Position ${i}: inserting block from index ${index}`, contentBlocks[index]);
                    newBlocks.push(contentBlocks[index]);
                } else if (i === index) {
                    // Insert previous block at current position
                    console.log(`[moveBlockUp] Position ${i}: inserting block from index ${index - 1}`, contentBlocks[index - 1]);
                    newBlocks.push(contentBlocks[index - 1]);
                } else {
                    // Keep other blocks in their original positions
                    console.log(`[moveBlockUp] Position ${i}: keeping block from index ${i}`, contentBlocks[i]);
                    newBlocks.push(contentBlocks[i]);
                }
            }
            
            console.log('[moveBlockUp] New blocks array length:', newBlocks.length);
            console.log('[moveBlockUp] New blocks:', JSON.parse(JSON.stringify(newBlocks.map(b => ({id: b.id, type: b.type, hasData: !!b.data})))));
            
            // Safety check: ensure we didn't lose any blocks
            if (newBlocks.length === originalLength) {
                // Replace the entire array with the new ordered array
                contentBlocks = newBlocks;
                console.log('[moveBlockUp] Array replaced successfully');
                console.log('[moveBlockUp] Final blocks before render:', JSON.parse(JSON.stringify(contentBlocks.map(b => ({id: b.id, type: b.type, hasData: !!b.data})))));
                
                // Re-render with the new order (skip save since we already saved)
                renderContentBlocks(true);
                console.log('[moveBlockUp] ===== END =====');
            } else {
                console.error('[moveBlockUp] Block count mismatch! Original:', originalLength, 'New:', newBlocks.length);
            }
        } else {
            console.log('[moveBlockUp] Invalid index or cannot move up');
        }
    }
    
    function moveBlockDown(blockId) {
        console.log('[moveBlockDown] ===== START =====');
        console.log('[moveBlockDown] Block ID to move:', blockId);
        console.log('[moveBlockDown] Current blocks before save:', JSON.parse(JSON.stringify(contentBlocks.map(b => ({id: b.id, type: b.type, hasData: !!b.data})))));
        
        // Save all block content before moving - this updates block.data for all blocks
        saveAllBlockContent();
        
        console.log('[moveBlockDown] Blocks after save:', JSON.parse(JSON.stringify(contentBlocks.map(b => ({id: b.id, type: b.type, hasData: !!b.data})))));
        
        const index = contentBlocks.findIndex(b => b.id === blockId);
        console.log('[moveBlockDown] Found block at index:', index);
        
        if (index >= 0 && index < contentBlocks.length - 1) {
            const originalLength = contentBlocks.length;
            console.log('[moveBlockDown] Original array length:', originalLength);
            console.log('[moveBlockDown] Block at index', index, ':', contentBlocks[index]);
            console.log('[moveBlockDown] Block at index', index + 1, ':', contentBlocks[index + 1]);
            
            // Create a new array with blocks in the new order to avoid any reference issues
            const newBlocks = [];
            for (let i = 0; i < contentBlocks.length; i++) {
                if (i === index) {
                    // Insert next block at current position
                    console.log(`[moveBlockDown] Position ${i}: inserting block from index ${index + 1}`, contentBlocks[index + 1]);
                    newBlocks.push(contentBlocks[index + 1]);
                } else if (i === index + 1) {
                    // Insert current block at next position
                    console.log(`[moveBlockDown] Position ${i}: inserting block from index ${index}`, contentBlocks[index]);
                    newBlocks.push(contentBlocks[index]);
                } else {
                    // Keep other blocks in their original positions
                    console.log(`[moveBlockDown] Position ${i}: keeping block from index ${i}`, contentBlocks[i]);
                    newBlocks.push(contentBlocks[i]);
                }
            }
            
            console.log('[moveBlockDown] New blocks array length:', newBlocks.length);
            console.log('[moveBlockDown] New blocks:', JSON.parse(JSON.stringify(newBlocks.map(b => ({id: b.id, type: b.type, hasData: !!b.data})))));
            
            // Safety check: ensure we didn't lose any blocks
            if (newBlocks.length === originalLength) {
                // Replace the entire array with the new ordered array
                contentBlocks = newBlocks;
                console.log('[moveBlockDown] Array replaced successfully');
                console.log('[moveBlockDown] Final blocks before render:', JSON.parse(JSON.stringify(contentBlocks.map(b => ({id: b.id, type: b.type, hasData: !!b.data})))));
                
                // Re-render with the new order (skip save since we already saved)
                renderContentBlocks(true);
                console.log('[moveBlockDown] ===== END =====');
            } else {
                console.error('[moveBlockDown] Block count mismatch! Original:', originalLength, 'New:', newBlocks.length);
            }
        } else {
            console.log('[moveBlockDown] Invalid index or cannot move down');
        }
    }
    
    function renderContentBlocks(skipSave) {
        console.log('[renderContentBlocks] ===== START =====');
        console.log('[renderContentBlocks] skipSave:', skipSave);
        console.log('[renderContentBlocks] Total blocks to render:', contentBlocks.length);
        console.log('[renderContentBlocks] Blocks:', JSON.parse(JSON.stringify(contentBlocks.map(b => ({id: b.id, type: b.type, hasData: !!b.data, dataType: typeof b.data})))));
        
        const container = document.getElementById('contentBlocksContainer');
        const noBlocksMessage = document.getElementById('noBlocksMessage');
        
        if (contentBlocks.length === 0) {
            console.log('[renderContentBlocks] No blocks to render');
            container.innerHTML = '<p class="text-muted text-center py-3" id="noBlocksMessage">No content blocks yet. Click buttons above to add blocks.</p>';
            return;
        }
        
        // Save all block content before destroying DOM elements (unless skipSave is true)
        if (!skipSave) {
            console.log('[renderContentBlocks] Calling saveAllBlockContent()');
            saveAllBlockContent();
        } else {
            console.log('[renderContentBlocks] Skipping saveAllBlockContent()');
        }
        
        // Clear existing Quill instances
        const quillInstanceCount = Object.keys(quillInstances).length;
        console.log('[renderContentBlocks] Clearing', quillInstanceCount, 'Quill instances');
        Object.keys(quillInstances).forEach(blockId => {
            delete quillInstances[blockId];
        });
        
        noBlocksMessage?.remove();
        container.innerHTML = '';
        
        let renderedCount = 0;
        contentBlocks.forEach((block, index) => {
            // Skip invalid blocks
            if (!block || !block.id || !block.type) {
                console.warn('[renderContentBlocks] Skipping invalid block at index', index, block);
                return;
            }
            
            console.log(`[renderContentBlocks] Rendering block ${index}: id=${block.id}, type=${block.type}, data=`, block.data);
            renderedCount++;
            
            const blockDiv = document.createElement('div');
            blockDiv.className = 'card mb-3 content-block-item';
            blockDiv.setAttribute('data-block-id', block.id);
            
            let blockContent = '';
            let lat = '';
            let lng = '';
            const typeLabels = {
                'content': 'Quill Editor',
                'injected_html': 'HTML Injection',
                'html_editor': 'HTML Tag Editor',
                'maps': 'Google Maps'
            };
            const typeIcons = {
                'content': 'fa-edit',
                'injected_html': 'fa-code',
                'html_editor': 'fa-tags',
                'maps': 'fa-map-marker-alt'
            };
            
            if (block.type === 'content') {
                blockContent = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${typeIcons[block.type]}"></i> <strong>${typeLabels[block.type]}</strong>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary" onclick="moveBlockUp('${block.id}')" ${index === 0 ? 'disabled' : ''} title="Move Up">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="moveBlockDown('${block.id}')" ${index === contentBlocks.length - 1 ? 'disabled' : ''} title="Move Down">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="removeContentBlock('${block.id}')" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="quillEditor_${block.id}"></div>
                    </div>
                `;
            } else if (block.type === 'injected_html') {
                blockContent = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${typeIcons[block.type]}"></i> <strong>${typeLabels[block.type]}</strong>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary" onclick="moveBlockUp('${block.id}')" ${index === 0 ? 'disabled' : ''} title="Move Up">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="moveBlockDown('${block.id}')" ${index === contentBlocks.length - 1 ? 'disabled' : ''} title="Move Down">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="removeContentBlock('${block.id}')" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control injected-html-textarea" rows="8" 
                                  placeholder="Paste or type raw HTML code here..."
                                  onchange="updateBlockData('${block.id}', this.value)"
                                  oninput="updateBlockData('${block.id}', this.value)">${escapeHtml(block.data || '')}</textarea>
                    </div>
                `;
            } else if (block.type === 'maps') {
                // Ensure block.data is an object with latitude and longitude
                if (!block.data || typeof block.data !== 'object') {
                    block.data = { latitude: '', longitude: '' };
                }
                lat = block.data.latitude || '';
                lng = block.data.longitude || '';
                blockContent = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${typeIcons[block.type]}"></i> <strong>${typeLabels[block.type]}</strong>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary" onclick="moveBlockUp('${block.id}')" ${index === 0 ? 'disabled' : ''} title="Move Up">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="moveBlockDown('${block.id}')" ${index === contentBlocks.length - 1 ? 'disabled' : ''} title="Move Down">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="removeContentBlock('${block.id}')" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Latitude</label>
                            <input type="number" step="any" class="form-control map-latitude-input" 
                                   placeholder="e.g., -6.2088" value="${lat}"
                                   onchange="updateMapsBlockData('${block.id}')">
                        </div>
                        <div class="form-group">
                            <label>Longitude</label>
                            <input type="number" step="any" class="form-control map-longitude-input" 
                                   placeholder="e.g., 106.8456" value="${lng}"
                                   onchange="updateMapsBlockData('${block.id}')">
                        </div>
                        <div class="form-group">
                            <div class="map-preview" id="mapPreview_${block.id}" style="height: 300px; border: 1px solid #ddd; border-radius: 4px; display: ${lat && lng ? 'block' : 'none'};"></div>
                        </div>
                    </div>
                `;
            } else if (block.type === 'html_editor') {
                // block.data is just the HTML string
                const htmlCode = block.data || '';
                blockContent = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-tags"></i> <strong>HTML Tag Editor</strong>
                            <small class="text-muted ml-2">Paste HTML and click tags to edit</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary" onclick="moveBlockUp('${block.id}')" ${index === 0 ? 'disabled' : ''} title="Move Up">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="moveBlockDown('${block.id}')" ${index === contentBlocks.length - 1 ? 'disabled' : ''} title="Move Down">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="removeContentBlock('${block.id}')" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>HTML Code</label>
                            <textarea class="form-control html-code-editor" rows="6" 
                                      placeholder="Paste your HTML template here..."
                                      onchange="updateHtmlEditorPreview('${block.id}')">${escapeHtml(htmlCode)}</textarea>
                            <small class="form-text text-muted">Paste HTML code above, then click on elements in the preview below to edit their content.</small>
                        </div>
                        <div class="form-group">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="mb-0">Preview (Click elements to edit)</label>
                                <button type="button" class="btn btn-sm btn-primary" onclick="updateHtmlEditorPreview('${block.id}')">
                                    <i class="fas fa-sync-alt"></i> Refresh Preview
                                </button>
                            </div>
                            <div class="html-editor-preview" id="htmlPreview_${block.id}">
                                <p class="text-muted text-center py-4">Enter HTML code above to see preview</p>
                            </div>
                        </div>
                        <div class="tag-editor-panel" id="tagEditor_${block.id}">
                            <h6 class="mb-3">
                                <i class="fas fa-edit"></i> Edit Tag: <code id="tagName_${block.id}"></code>
                            </h6>
                            <div class="form-group">
                                <label>Content</label>
                                <textarea class="form-control" id="tagContent_${block.id}" rows="3"></textarea>
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="closeTagEditor('${block.id}')">
                                    Cancel
                                </button>
                                <button type="button" class="btn btn-sm btn-success" onclick="saveTagContent('${block.id}')">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            blockDiv.innerHTML = blockContent;
            container.appendChild(blockDiv);
            
            // Initialize Quill for content blocks
            if (block.type === 'content') {
                setTimeout(() => {
                    // Make sure we don't already have an instance for this block
                    if (!quillInstances[block.id]) {
                        initQuillForBlock(block.id, block.data || '');
                    }
                }, 100);
            }
            
            // Initialize map preview for maps blocks
            if (block.type === 'maps' && lat && lng) {
                setTimeout(() => {
                    updateMapPreviewForBlock(block.id, lat, lng);
                }, 100);
            }
            
            // Initialize HTML editor preview for html_editor blocks
            if (block.type === 'html_editor') {
                setTimeout(() => {
                    updateHtmlEditorPreview(block.id);
                }, 100);
            }
        });
        
        console.log('[renderContentBlocks] Rendered', renderedCount, 'blocks out of', contentBlocks.length);
        console.log('[renderContentBlocks] ===== END =====');
    }
    
    function initQuillForBlock(blockId, initialContent) {
        const editorDiv = document.getElementById(`quillEditor_${blockId}`);
        if (!editorDiv) {
            console.warn(`Quill editor div not found for block ${blockId}`);
            return;
        }
        
        // If instance already exists, don't create a new one
        if (quillInstances[blockId]) {
            console.warn(`Quill instance already exists for block ${blockId}`);
            return;
        }
        
        // Set icons for file-picker buttons
        const icons = Quill.import('ui/icons');
        icons['file-picker'] = '<i class="fas fa-folder"></i>';
        icons['file-picker-static'] = '<i class="fas fa-folder"></i>';
        
        const modulesConfig = {
            toolbar: {
                container: [
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['file-picker'],
                    ['file-picker-static'],
                    ['clean']
                ],
                handlers: {
                    'file-picker': function() {
                        showFilePickerModal('db');
                    },
                    'file-picker-static': function() {
                        showFilePickerModal('static');
                    }
                }
            },
            clipboard: {
                matchVisual: false
            }
        };
        
        // Add imageResize if available
        if (typeof ImageResize !== 'undefined') {
            let ImageResizeModule = null;
            if (typeof ImageResize === 'function') {
                ImageResizeModule = ImageResize;
            } else if (ImageResize.default && typeof ImageResize.default === 'function') {
                ImageResizeModule = ImageResize.default;
            }
            
            if (ImageResizeModule && !Quill.imports['modules/imageResize']) {
                try {
                    Quill.register('modules/imageResize', ImageResizeModule, true);
                } catch (e) {
                    console.error('Error registering ImageResize:', e);
                }
            }
            
            if (ImageResizeModule) {
                modulesConfig.imageResize = {
                    parchment: Quill.import('parchment'),
                    modules: ['Resize', 'DisplaySize', 'Toolbar']
                };
            }
        }
        
        const quill = new Quill(`#quillEditor_${blockId}`, {
            theme: 'snow',
            modules: modulesConfig,
            formats: ['bold', 'italic', 'underline', 'strike', 'header', 'list', 'bullet', 'color', 'background', 'align', 'link', 'image', 'width', 'height']
        });
        
        if (initialContent) {
            quill.clipboard.dangerouslyPasteHTML(0, initialContent);
        }
        
        quillInstances[blockId] = quill;
    }
    
    function updateBlockData(blockId, value) {
        const block = contentBlocks.find(b => b.id === blockId);
        if (block) {
            block.data = value;
        }
    }
    
    function updateMapsBlockData(blockId) {
        const blockDiv = document.querySelector(`[data-block-id="${blockId}"]`);
        if (!blockDiv) return;
        
        const latInput = blockDiv.querySelector('.map-latitude-input');
        const lngInput = blockDiv.querySelector('.map-longitude-input');
        const lat = parseFloat(latInput.value);
        const lng = parseFloat(lngInput.value);
        
        const block = contentBlocks.find(b => b.id === blockId);
        if (block) {
            block.data = {
                latitude: isNaN(lat) ? '' : lat,
                longitude: isNaN(lng) ? '' : lng
            };
            updateMapPreviewForBlock(blockId, block.data.latitude, block.data.longitude);
        }
    }
    
    function updateMapPreviewForBlock(blockId, lat, lng) {
        const previewDiv = document.getElementById(`mapPreview_${blockId}`);
        if (!previewDiv) return;
        
        if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
            previewDiv.style.display = 'block';
            const embedUrl = `https://maps.google.com/maps?q=${lat},${lng}&hl=en&z=14&output=embed`;
            previewDiv.innerHTML = `<iframe src="${embedUrl}" width="100%" height="100%" style="border:0; border-radius:4px;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
        } else {
            previewDiv.style.display = 'none';
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // HTML Tag Editor Functions
    function updateHtmlEditorPreview(blockId) {
        const blockDiv = document.querySelector(`[data-block-id="${blockId}"]`);
        if (!blockDiv) return;
        
        const textarea = blockDiv.querySelector('.html-code-editor');
        const preview = document.getElementById(`htmlPreview_${blockId}`);
        if (!textarea || !preview) return;
        
        const htmlCode = textarea.value.trim();
        
        if (!htmlCode) {
            preview.innerHTML = '<p class="text-muted text-center py-4">Enter HTML code above to see preview</p>';
            return;
        }
        
        // Parse HTML and make elements editable
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlCode;
        
        // Make all elements with text content editable (just add markers, don't modify content)
        makeElementsEditable(tempDiv, blockId);
        
        preview.innerHTML = tempDiv.innerHTML;
        
        // Add click event listeners to editable elements
        preview.querySelectorAll('[data-editable-tag]').forEach(el => {
            el.addEventListener('click', (e) => {
                e.stopPropagation();
                selectTagForEditing(blockId, el);
            });
        });
    }
    
    function makeElementsEditable(element, blockId, path = []) {
        Array.from(element.children).forEach((child, index) => {
            const currentPath = [...path, index];
            const pathStr = currentPath.join('-');
            
            // Add data attributes for identification
            child.setAttribute('data-editable-tag', pathStr);
            child.setAttribute('data-tag-name', child.tagName.toLowerCase());
            
            // Recursively process children
            if (child.children.length > 0) {
                makeElementsEditable(child, blockId, currentPath);
            }
        });
    }
    
    function selectTagForEditing(blockId, element) {
        const blockDiv = document.querySelector(`[data-block-id="${blockId}"]`);
        if (!blockDiv) return;
        
        const preview = document.getElementById(`htmlPreview_${blockId}`);
        const tagEditor = document.getElementById(`tagEditor_${blockId}`);
        const tagName = document.getElementById(`tagName_${blockId}`);
        const tagContent = document.getElementById(`tagContent_${blockId}`);
        
        if (!preview || !tagEditor || !tagName || !tagContent) return;
        
        // Remove previous selection
        preview.querySelectorAll('[data-editable-tag].selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // Mark current element as selected
        element.classList.add('selected');
        
        // Get element path and tag name
        const path = element.getAttribute('data-editable-tag');
        const tag = element.getAttribute('data-tag-name');
        
        // Get direct text content (not including nested elements)
        const textNodes = Array.from(element.childNodes).filter(node => node.nodeType === Node.TEXT_NODE);
        const currentText = textNodes.map(node => node.textContent).join('').trim();
        
        // Show tag editor panel
        tagEditor.classList.add('active');
        tagName.textContent = `<${tag}> [${path}]`;
        tagContent.value = currentText;
        tagContent.setAttribute('data-editing-path', path);
        tagContent.focus();
        
        // Store current editing element
        tagEditor.setAttribute('data-current-element', path);
    }
    
    function closeTagEditor(blockId) {
        const tagEditor = document.getElementById(`tagEditor_${blockId}`);
        const preview = document.getElementById(`htmlPreview_${blockId}`);
        
        if (tagEditor) {
            tagEditor.classList.remove('active');
        }
        
        if (preview) {
            preview.querySelectorAll('[data-editable-tag].selected').forEach(el => {
                el.classList.remove('selected');
            });
        }
    }
    
    function saveTagContent(blockId) {
        const blockDiv = document.querySelector(`[data-block-id="${blockId}"]`);
        if (!blockDiv) return;
        
        const tagEditor = document.getElementById(`tagEditor_${blockId}`);
        const tagContent = document.getElementById(`tagContent_${blockId}`);
        const preview = document.getElementById(`htmlPreview_${blockId}`);
        const htmlTextarea = blockDiv.querySelector('.html-code-editor');
        
        if (!tagEditor || !tagContent || !preview || !htmlTextarea) return;
        
        const path = tagContent.getAttribute('data-editing-path');
        const newContent = tagContent.value;
        
        // Find the block in contentBlocks
        const block = contentBlocks.find(b => b.id === blockId);
        if (!block) return;
        
        // Update the preview element visually
        const element = preview.querySelector(`[data-editable-tag="${path}"]`);
        if (element) {
            // Get text nodes only
            const textNodes = Array.from(element.childNodes).filter(node => node.nodeType === Node.TEXT_NODE);
            if (textNodes.length > 0) {
                textNodes[0].textContent = newContent;
            } else if (element.children.length === 0) {
                element.textContent = newContent;
            }
        }
        
        // Now update the HTML source directly by parsing and reconstructing
        try {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlTextarea.value;
            
            // Find element by path and update its text content
            const pathParts = path.split('-').map(Number);
            let targetElement = tempDiv;
            
            for (let i = 0; i < pathParts.length; i++) {
                const childIndex = pathParts[i];
                const children = Array.from(targetElement.children);
                if (childIndex < children.length) {
                    targetElement = children[childIndex];
                } else {
                    console.warn('Path not found in HTML:', path);
                    break;
                }
            }
            
            // Update text content if element found
            if (targetElement && targetElement !== tempDiv) {
                // Get text nodes only
                const textNodes = Array.from(targetElement.childNodes).filter(node => node.nodeType === Node.TEXT_NODE);
                if (textNodes.length > 0) {
                    textNodes[0].textContent = newContent;
                } else if (targetElement.children.length === 0) {
                    targetElement.textContent = newContent;
                }
                
                // Update the textarea with new HTML (this is the source of truth)
                htmlTextarea.value = tempDiv.innerHTML;
                
                // Update block data with new HTML directly
                block.data = tempDiv.innerHTML;
            }
        } catch (e) {
            console.error('Error updating HTML:', e);
        }
        
        // Close tag editor
        closeTagEditor(blockId);
        
        // Show success message
        showToast('Content saved directly to HTML!', 'success');
    }

    function editItem(key, label) {
        document.getElementById('nav_name').value = key;
        document.getElementById('nav_label').value = label;
        document.getElementById('nav_key_old').value = key;
        
        // Clear existing blocks and Quill instances
        contentBlocks = [];
        Object.keys(quillInstances).forEach(blockId => {
            delete quillInstances[blockId];
        });
        
        // Load content blocks - try new format first, then legacy format
        if (blocksData[key] && Array.isArray(blocksData[key])) {
            // New format with blocks
            blocksData[key].forEach((block, index) => {
                const blockId = 'block_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2, 9);
                let blockData = block.data;
                
                // Ensure maps data has proper structure
                if (block.type === 'maps') {
                    if (!blockData || typeof blockData !== 'object') {
                        blockData = { latitude: '', longitude: '' };
                    } else {
                        blockData = {
                            latitude: blockData.latitude || '',
                            longitude: blockData.longitude || ''
                        };
                    }
                } else if (block.type === 'html_editor') {
                    // For html_editor, blockData is just the HTML string
                    // Handle legacy format where it might be an object
                    if (blockData && typeof blockData === 'object' && blockData.html) {
                        blockData = blockData.html;  // Extract HTML from legacy format
                    } else if (typeof blockData !== 'string') {
                        blockData = '';
                    }
                }
                
                contentBlocks.push({
                    id: blockId,
                    type: block.type,
                    data: blockData || ''
                });
            });
        } else {
            // Legacy format - convert to blocks
            if (contentData[key]) {
                contentBlocks.push({
                    id: 'block_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    type: 'content',
                    data: contentData[key]
                });
            }
            if (injectedHtmlData[key]) {
                contentBlocks.push({
                    id: 'block_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    type: 'injected_html',
                    data: injectedHtmlData[key]
                });
            }
            if (pluginData[key] && pluginData[key].maps) {
                const mapsPlugin = pluginData[key].maps;
                if (mapsPlugin.latitude && mapsPlugin.longitude) {
                    contentBlocks.push({
                        id: 'block_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        type: 'maps',
                        data: {
                            latitude: mapsPlugin.latitude,
                            longitude: mapsPlugin.longitude
                        }
                    });
                }
            }
        }
        
        renderContentBlocks();
        
        // Load background color from plugin structure
        let bgColor = '';
        if (pluginData[key] && pluginData[key].background_color) {
            bgColor = pluginData[key].background_color;
        }
        
        // Set background color fields and show/hide background color form
        if (bgColor) {
            document.getElementById('enableBackgroundColor').checked = true;
            document.getElementById('backgroundColorCard').style.display = 'block';
            document.getElementById('section_background_color_text').value = bgColor;
            // Try to sync color picker if it's a hex color
            const hexMatch = bgColor.match(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/);
            if (hexMatch) {
                let hexValue = bgColor;
                // Normalize 3-digit hex to 6-digit
                if (hexValue.length === 4) {
                    hexValue = '#' + hexValue[1] + hexValue[1] + 
                              hexValue[2] + hexValue[2] + 
                              hexValue[3] + hexValue[3];
                }
                document.getElementById('section_background_color_picker').value = hexValue;
            }
            updateBackgroundColorPreview();
        } else {
            document.getElementById('enableBackgroundColor').checked = false;
            document.getElementById('backgroundColorCard').style.display = 'none';
            document.getElementById('section_background_color_picker').value = '#ffffff';
            document.getElementById('section_background_color_text').value = '';
            updateBackgroundColorPreview();
        }
        
        // Scroll to form
        document.getElementById('mainForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function clearForm() {
        document.getElementById('mainForm').reset();
        document.getElementById('nav_key_old').value = '';
        
        // Clear all content blocks
        contentBlocks = [];
        Object.keys(quillInstances).forEach(blockId => {
            delete quillInstances[blockId];
        });
        renderContentBlocks();
        
        // Clear background color fields
        document.getElementById('enableBackgroundColor').checked = false;
        document.getElementById('backgroundColorCard').style.display = 'none';
        document.getElementById('section_background_color_picker').value = '#ffffff';
        document.getElementById('section_background_color_text').value = '';
        updateBackgroundColorPreview();
    }

    function toggleBackgroundColorForm() {
        const checkbox = document.getElementById('enableBackgroundColor');
        const bgColorCard = document.getElementById('backgroundColorCard');
        
        if (checkbox.checked) {
            bgColorCard.style.display = 'block';
        } else {
            bgColorCard.style.display = 'none';
            // Clear background color fields when disabled
            document.getElementById('section_background_color').value = '#ffffff';
            document.getElementById('section_background_color_text').value = '';
            updateBackgroundColorPreview();
        }
    }

    function updateBackgroundColorPreview() {
        const colorPicker = document.getElementById('section_background_color_picker');
        const textInput = document.getElementById('section_background_color_text');
        const previewDiv = document.getElementById('backgroundColorPreview');
        
        let backgroundValue = textInput.value.trim();
        
        // Update preview with any CSS background value
        if (previewDiv) {
            if (backgroundValue) {
                previewDiv.style.background = backgroundValue;
                // Try to determine text color for contrast (only for solid colors)
                const rgb = parseColorToRgb(backgroundValue);
                if (rgb) {
                    const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
                    previewDiv.style.color = brightness > 128 ? '#000000' : '#ffffff';
                } else {
                    // For gradients or complex backgrounds, use default text color
                    previewDiv.style.color = '#000000';
                }
            } else {
                previewDiv.style.background = '#ffffff';
                previewDiv.style.color = '#000000';
            }
        }
        
        // Sync color picker only if it's a simple hex color
        if (colorPicker && backgroundValue) {
            const hexMatch = backgroundValue.match(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/);
            if (hexMatch) {
                // Normalize 3-digit hex to 6-digit
                if (backgroundValue.length === 4) {
                    backgroundValue = '#' + backgroundValue[1] + backgroundValue[1] + 
                                    backgroundValue[2] + backgroundValue[2] + 
                                    backgroundValue[3] + backgroundValue[3];
                }
                colorPicker.value = backgroundValue;
            }
        }
    }

    function parseColorToRgb(colorValue) {
        if (!colorValue) return null;
        
        // Try hex color
        let hexMatch = colorValue.match(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/);
        if (hexMatch) {
            return hexToRgb(colorValue);
        }
        
        // Try rgb/rgba
        let rgbMatch = colorValue.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
        if (rgbMatch) {
            return {
                r: parseInt(rgbMatch[1]),
                g: parseInt(rgbMatch[2]),
                b: parseInt(rgbMatch[3])
            };
        }
        
        // Try named colors (basic set)
        const namedColors = {
            'red': {r: 255, g: 0, b: 0},
            'green': {r: 0, g: 128, b: 0},
            'blue': {r: 0, g: 0, b: 255},
            'white': {r: 255, g: 255, b: 255},
            'black': {r: 0, g: 0, b: 0},
            'yellow': {r: 255, g: 255, b: 0},
            'cyan': {r: 0, g: 255, b: 255},
            'magenta': {r: 255, g: 0, b: 255},
            'gray': {r: 128, g: 128, b: 128},
            'grey': {r: 128, g: 128, b: 128}
        };
        if (namedColors[colorValue.toLowerCase()]) {
            return namedColors[colorValue.toLowerCase()];
        }
        
        return null; // Can't parse (gradient, etc.)
    }

    function clearBackgroundColor() {
        document.getElementById('section_background_color_picker').value = '#ffffff';
        document.getElementById('section_background_color_text').value = '';
        updateBackgroundColorPreview();
    }

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }


    function addNewSection() {
        clearForm();
        // Scroll to form
        document.getElementById('mainForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Focus on nav_name input
        setTimeout(function() {
            document.getElementById('nav_name').focus();
        }, 300);
    }

    // Quick helper to change selected text color in Quill (for first focused editor)
    function setQuillTextColor(color) {
        // Find the currently focused Quill editor
        let activeQuill = null;
        Object.keys(quillInstances).forEach(blockId => {
            const quill = quillInstances[blockId];
            if (quill && quill.hasFocus()) {
                activeQuill = quill;
            }
        });
        
        // If no focused editor, use the first one
        if (!activeQuill) {
            const contentBlock = contentBlocks.find(b => b.type === 'content');
            if (contentBlock && quillInstances[contentBlock.id]) {
                activeQuill = quillInstances[contentBlock.id];
            }
        }
        
        if (activeQuill) {
            activeQuill.focus();
            activeQuill.format('color', color || false);
        }
    }
    
    // File picker functions
    let currentFileSource = 'db'; // 'db' or 'static'
    
    function showFilePickerModal(source) {
        const modal = document.getElementById('filePickerModal');
        if (!modal) return;
        
        // Set current source
        currentFileSource = source || 'db';
        
        // Update modal title and icon
        const modalTitle = document.getElementById('filePickerModalTitle');
        const modalIcon = document.getElementById('filePickerModalIcon');
        const toggleButtons = document.getElementById('filePickerSourceToggle');
        
        if (currentFileSource === 'static') {
            if (modalTitle) modalTitle.textContent = 'Select File (Static/JSON)';
            if (modalIcon) {
                modalIcon.className = 'fas fa-folder';
                modalIcon.style.color = '#dc3545';
            }
            // Show toggle buttons
            if (toggleButtons) toggleButtons.style.display = 'flex';
            // Set active button
            document.getElementById('toggleStaticFiles')?.classList.add('active');
            document.getElementById('toggleDbFiles')?.classList.remove('active');
        } else {
            if (modalTitle) modalTitle.textContent = 'Select File (Database)';
            if (modalIcon) {
                modalIcon.className = 'fas fa-folder';
                modalIcon.style.color = '';
            }
            // Show toggle buttons
            if (toggleButtons) toggleButtons.style.display = 'flex';
            // Set active button
            document.getElementById('toggleDbFiles')?.classList.add('active');
            document.getElementById('toggleStaticFiles')?.classList.remove('active');
        }
        
        // Show modal
        if (typeof $ !== 'undefined') {
            $(modal).modal('show');
        } else {
            modal.style.display = 'block';
            modal.classList.add('show');
        }
        
        // Load files
        loadFileList(currentFileSource);
    }
    
    function switchFileSource(source) {
        currentFileSource = source;
        loadFileList(source);
        
        // Update button states
        if (source === 'static') {
            document.getElementById('toggleStaticFiles')?.classList.add('active');
            document.getElementById('toggleDbFiles')?.classList.remove('active');
            const modalTitle = document.getElementById('filePickerModalTitle');
            const modalIcon = document.getElementById('filePickerModalIcon');
            if (modalTitle) modalTitle.textContent = 'Select File (Static/JSON)';
            if (modalIcon) {
                modalIcon.style.color = '#dc3545';
            }
        } else {
            document.getElementById('toggleDbFiles')?.classList.add('active');
            document.getElementById('toggleStaticFiles')?.classList.remove('active');
            const modalTitle = document.getElementById('filePickerModalTitle');
            const modalIcon = document.getElementById('filePickerModalIcon');
            if (modalTitle) modalTitle.textContent = 'Select File (Database)';
            if (modalIcon) {
                modalIcon.style.color = '';
            }
        }
    }
    
    function loadFileList(source) {
        const loadingDiv = document.getElementById('filePickerLoading');
        const listDiv = document.getElementById('filePickerList');
        const emptyDiv = document.getElementById('filePickerEmpty');
        const container = document.getElementById('fileListContainer');
        
        // Show loading
        loadingDiv.style.display = 'block';
        listDiv.style.display = 'none';
        emptyDiv.style.display = 'none';
        container.innerHTML = '';
        
        // Determine API endpoint based on source
        const apiUrl = source === 'static' 
            ? '{{ url_for("admin_file_list_static_api") }}'
            : '{{ url_for("admin_file_list_api") }}';
        
        // Fetch files from API
        fetch(apiUrl)
            .then(response => response.json())
            .then(files => {
                loadingDiv.style.display = 'none';
                
                if (!files || files.length === 0) {
                    emptyDiv.style.display = 'block';
                    return;
                }
                
                // Display files
                listDiv.style.display = 'block';
                files.forEach((file, index) => {
                    const fileItem = document.createElement('a');
                    fileItem.href = '#';
                    fileItem.className = 'list-group-item list-group-item-action file-picker-item';
                    fileItem.onclick = function(e) {
                        e.preventDefault();
                        insertFileLink(file);
                        // Close modal
                        if (typeof $ !== 'undefined') {
                            $('#filePickerModal').modal('hide');
                        } else {
                            const modal = document.getElementById('filePickerModal');
                            modal.style.display = 'none';
                            modal.classList.remove('show');
                        }
                    };
                    
                    // Format file size
                    let fileSizeText = '-';
                    if (file.file_size) {
                        if (file.file_size < 1024) {
                            fileSizeText = file.file_size + ' B';
                        } else if (file.file_size < 1048576) {
                            fileSizeText = (file.file_size / 1024).toFixed(2) + ' KB';
                        } else {
                            fileSizeText = (file.file_size / 1048576).toFixed(2) + ' MB';
                        }
                    }
                    
                    fileItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <i class="fas fa-file"></i> ${escapeHtml(file.display_name || file.original_filename || file.file)}
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-tag"></i> ${escapeHtml(file.original_filename || file.file)}
                                    <span class="ml-2"><i class="fas fa-hdd"></i> ${fileSizeText}</span>
                                </small>
                            </div>
                            <div>
                                <i class="fas fa-chevron-right text-muted"></i>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(fileItem);
                });
            })
            .catch(error => {
                console.error('Error loading files:', error);
                loadingDiv.style.display = 'none';
                emptyDiv.style.display = 'block';
                emptyDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <p class="text-danger">Error loading files. Please try again.</p>
                `;
            });
    }
    
    function insertFileLink(file) {
        // Find the currently focused Quill editor
        let activeQuill = null;
        Object.keys(quillInstances).forEach(blockId => {
            const quill = quillInstances[blockId];
            if (quill && quill.hasFocus()) {
                activeQuill = quill;
            }
        });
        
        // If no focused editor, use the first one or create a new content block
        if (!activeQuill) {
            // Try to find any content block
            const contentBlock = contentBlocks.find(b => b.type === 'content');
            if (contentBlock && quillInstances[contentBlock.id]) {
                activeQuill = quillInstances[contentBlock.id];
            } else {
                // Create a new content block
                addContentBlock('content');
                setTimeout(() => {
                    const newBlock = contentBlocks[contentBlocks.length - 1];
                    if (quillInstances[newBlock.id]) {
                        activeQuill = quillInstances[newBlock.id];
                        insertFileLinkIntoQuill(activeQuill, file);
                    }
                }, 200);
                return;
            }
        }
        
        if (activeQuill) {
            insertFileLinkIntoQuill(activeQuill, file);
        }
    }
    
    function insertFileLinkIntoQuill(quill, file) {
        const range = quill.getSelection(true);
        if (!range) {
            quill.focus();
            const newRange = quill.getSelection(true);
            if (!newRange) {
                quill.setSelection(quill.getLength());
            }
        }
        
        const currentRange = quill.getSelection(true) || { index: quill.getLength() };
        
        // Get display name or original filename
        const displayName = file.display_name || file.original_filename || file.file;
        const fileUrl = file.url || file.location || '';
        
        if (fileUrl) {
            // Insert as link
            quill.insertText(currentRange.index, displayName, 'link', fileUrl, 'user');
            // Move cursor after the link
            quill.setSelection(currentRange.index + displayName.length);
        } else {
            // Just insert text if no URL
            quill.insertText(currentRange.index, displayName, 'user');
            quill.setSelection(currentRange.index + displayName.length);
        }
        
        quill.focus();
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Initialize Sortable for navigation list
    function initSortableNavList() {
        const navList = document.getElementById('sortableNavList');
        if (!navList) {
            console.log('Sortable nav list not found');
            return;
        }
        
        if (typeof Sortable === 'undefined') {
            console.error('SortableJS library not loaded');
            return;
        }
        
        new Sortable(navList, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: function(evt) {
                // Get the new order of navigation keys
                const items = navList.querySelectorAll('.sortable-item');
                const newOrder = Array.from(items).map(item => item.getAttribute('data-key'));
                
                console.log('New order:', newOrder);
                
                // Save the new order to the server
                saveNavigationOrder(newOrder);
            }
        });
        
        console.log('Sortable initialized successfully');
    }
    
    // Save navigation order to server
    function saveNavigationOrder(order) {
        // Show loading indicator
        const navList = document.getElementById('sortableNavList');
        if (navList) {
            navList.style.opacity = '0.6';
            navList.style.pointerEvents = 'none';
        }
        
        fetch('{{ url_for("admin_web_control_reorder_nav") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ order: order })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Navigation order saved successfully');
                // Show success feedback
                showToast('Navigation order saved successfully!', 'success');
            } else {
                console.error('Failed to save navigation order:', data.message);
                showToast('Failed to save order: ' + (data.message || 'Unknown error'), 'error');
                // Reload page to restore original order
                setTimeout(() => location.reload(), 2000);
            }
        })
        .catch(error => {
            console.error('Error saving navigation order:', error);
            showToast('Error saving order. Reloading...', 'error');
            // Reload page to restore original order
            setTimeout(() => location.reload(), 2000);
        })
        .finally(() => {
            // Hide loading indicator
            if (navList) {
                navList.style.opacity = '1';
                navList.style.pointerEvents = 'auto';
            }
        });
    }
    
    // Show toast notification
    function showToast(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Wait for ImageResize module to load and register it globally
        function initImageResize() {
            // Check if ImageResize is available (try different export formats)
            let ImageResizeModule = null;
            
            if (typeof ImageResize !== 'undefined') {
                // Try different export formats
                if (typeof ImageResize === 'function') {
                    ImageResizeModule = ImageResize;
                } else if (ImageResize.default && typeof ImageResize.default === 'function') {
                    ImageResizeModule = ImageResize.default;
                } else if (ImageResize.ImageResize && typeof ImageResize.ImageResize === 'function') {
                    ImageResizeModule = ImageResize.ImageResize;
                } else if (typeof ImageResize === 'object') {
                    ImageResizeModule = ImageResize;
                }
            }
            
            if (!ImageResizeModule) {
                console.log('Waiting for ImageResize module to load...');
                setTimeout(initImageResize, 100);
                return;
            }
            
            // Register ImageResize module with Quill globally
            try {
                if (!Quill.imports['modules/imageResize']) {
                    Quill.register('modules/imageResize', ImageResizeModule, true);
                    console.log('ImageResize module registered successfully');
                }
            } catch (e) {
                console.error('Error registering ImageResize module:', e);
            }
        }
        
        // Start ImageResize initialization
        initImageResize();
        
        // Set up form submit handler
        const mainForm = document.getElementById('mainForm');
        if (mainForm) {
            mainForm.addEventListener('submit', function(e) {
                // Collect data from all blocks
                const blocks = [];
                contentBlocks.forEach(block => {
                    if (block.type === 'content') {
                        const quill = quillInstances[block.id];
                        if (quill) {
                            blocks.push({
                                type: 'content',
                                data: quill.root.innerHTML
                            });
                        }
                    } else if (block.type === 'injected_html') {
                        const blockDiv = document.querySelector(`[data-block-id="${block.id}"]`);
                        if (blockDiv) {
                            const textarea = blockDiv.querySelector('textarea');
                            if (textarea) {
                                blocks.push({
                                    type: 'injected_html',
                                    data: textarea.value
                                });
                            }
                        }
                    } else if (block.type === 'maps') {
                        const blockDiv = document.querySelector(`[data-block-id="${block.id}"]`);
                        if (blockDiv) {
                            const latInput = blockDiv.querySelector('.map-latitude-input');
                            const lngInput = blockDiv.querySelector('.map-longitude-input');
                            const lat = parseFloat(latInput?.value);
                            const lng = parseFloat(lngInput?.value);
                            if (!isNaN(lat) && !isNaN(lng)) {
                                blocks.push({
                                    type: 'maps',
                                    data: {
                                        latitude: lat,
                                        longitude: lng
                                    }
                                });
                            }
                        }
                    } else if (block.type === 'html_editor') {
                        const blockDiv = document.querySelector(`[data-block-id="${block.id}"]`);
                        if (blockDiv) {
                            const htmlTextarea = blockDiv.querySelector('.html-code-editor');
                            if (htmlTextarea) {
                                blocks.push({
                                    type: 'html_editor',
                                    data: htmlTextarea.value  // Just save the HTML directly
                                });
                            }
                        }
                    }
                });
                
                // Save blocks data to hidden input
                document.getElementById('contentBlocksData').value = JSON.stringify(blocks);
                
                // Clear background color field if checkbox is unchecked
                const enableBgColorCheckbox = document.getElementById('enableBackgroundColor');
                if (!enableBgColorCheckbox.checked) {
                    document.getElementById('section_background_color_text').value = '';
                }
            });
        }

        // Handle edit button clicks
        document.querySelectorAll('.edit-item-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                editItem(
                    this.getAttribute('data-key'),
                    this.getAttribute('data-label')
                );
            });
        });

        // Handle delete form submissions
        document.querySelectorAll('.delete-form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                const label = this.getAttribute('data-label');
                if (!confirm('Are you sure you want to delete "' + label + '"?')) {
                    e.preventDefault();
                    return false;
                }
            });
        });

        // Handle background color changes
        const bgColorPicker = document.getElementById('section_background_color_picker');
        const bgColorTextInput = document.getElementById('section_background_color_text');
        
        if (bgColorPicker) {
            bgColorPicker.addEventListener('input', function() {
                // When color picker changes, update text input with hex value
                bgColorTextInput.value = this.value;
                updateBackgroundColorPreview();
            });
        }
        
        if (bgColorTextInput) {
            bgColorTextInput.addEventListener('input', function() {
                // Update preview in real-time as user types
                updateBackgroundColorPreview();
            });
            
            bgColorTextInput.addEventListener('blur', function() {
                // Ensure preview is updated when user leaves the field
                updateBackgroundColorPreview();
            });
        }


        // Load templates
        loadTemplates();
        
        // Initialize drawer state on page load (drawer is open by default)
        const existingSection = document.getElementById('existingItemsSection');
        const editSection = document.getElementById('editSection');
        const rowContainer = existingSection ? existingSection.closest('.row') : null;
        
        if (existingSection && existingSection.classList.contains('drawer-open')) {
            // Drawer is open - CSS calc() handles width automatically
            if (rowContainer) {
                rowContainer.classList.add('drawer-open-adjacent');
            }
            if (editSection) {
                // Remove Bootstrap column classes - CSS calc() handles width
                editSection.classList.remove('col-lg-12', 'col-lg-6');
            }
            
            // Set initial icon states
            const icon = document.getElementById('toggleExistingItemsIcon');
            if (icon) {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
            
            const drawerToggleIcon = document.getElementById('drawerToggleIcon');
            if (drawerToggleIcon) {
                drawerToggleIcon.classList.add('drawer-open-icon');
            }
        }
        
        // Initialize Sortable for drag and drop navigation reordering
        initSortableNavList();
    });
    
    // Load templates from server
    function loadTemplates() {
        fetch('{{ url_for("admin_web_control_templates") }}')
            .then(response => response.json())
            .then(templates => {
                const templateList = document.getElementById('templateList');
                templateList.innerHTML = '';
                
                if (Object.keys(templates).length === 0) {
                    templateList.innerHTML = '<div class="dropdown-item-text text-muted">No templates available</div>';
                    return;
                }
                
                Object.keys(templates).forEach(key => {
                    const template = templates[key];
                    const item = document.createElement('a');
                    item.className = 'dropdown-item';
                    item.href = '#';
                    item.innerHTML = `
                        <div>
                            <strong>${template.label || template.name}</strong>
                            ${template.description ? '<small class="text-muted d-block">' + template.description + '</small>' : ''}
                        </div>
                    `;
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        applyTemplate(template);
                        // Close dropdown using jQuery (Bootstrap 4)
                        if (typeof $ !== 'undefined') {
                            $('.dropdown-menu').removeClass('show');
                            $('.dropdown-toggle').attr('aria-expanded', 'false');
                        }
                    });
                    templateList.appendChild(item);
                });
            })
            .catch(error => {
                console.error('Error loading templates:', error);
                document.getElementById('templateList').innerHTML = '<div class="dropdown-item-text text-danger">Error loading templates</div>';
            });
    }
    
    // Apply template to form
    function applyTemplate(template) {
        if (!template) return;
        
        // Fill nav_name if empty
        const navNameInput = document.getElementById('nav_name');
        if (!navNameInput.value.trim()) {
            navNameInput.value = template.name || '';
        }
        
        // Fill nav_label if empty
        const navLabelInput = document.getElementById('nav_label');
        if (!navLabelInput.value.trim()) {
            navLabelInput.value = template.label || template.name || '';
        }
        
        // Fill content in Quill editor
        if (quill && template.content) {
            quill.clipboard.dangerouslyPasteHTML(0, template.content);
        }
        
        // Handle map if template has map
        if (template.has_map) {
            document.getElementById('enableMapsPlugin').checked = true;
            document.getElementById('mapsPluginCard').style.display = 'block';
            // Don't auto-fill coordinates, let user enter them
        }
        
        // Show success message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
            Template "${template.label || template.name}" loaded successfully!
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;
        const form = document.getElementById('mainForm');
        form.insertBefore(alertDiv, form.firstChild);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
        
        // Scroll to form
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Toggle existing items drawer (right sidebar)
    function toggleExistingItemsSection() {
        const existingSection = document.getElementById('existingItemsSection');
        const editSection = document.getElementById('editSection');
        const rowContainer = existingSection ? existingSection.closest('.row') : null;
        const icon = document.getElementById('toggleExistingItemsIcon');
        const drawerToggleIcon = document.getElementById('drawerToggleIcon');

        if (!existingSection) return;

        const isOpen = existingSection.classList.toggle('drawer-open');

        // Adjust edit section width based on drawer state
        if (rowContainer) {
            if (isOpen) {
                // Drawer is open - edit section uses calc(100% - 420px) via CSS
                rowContainer.classList.remove('drawer-closed-adjacent');
                rowContainer.classList.add('drawer-open-adjacent');
                if (editSection) {
                    // Remove Bootstrap column classes - CSS calc() handles width
                    editSection.classList.remove('col-lg-12', 'col-lg-6');
                }
            } else {
                // Drawer is closed - make edit section full width
                rowContainer.classList.remove('drawer-open-adjacent');
                rowContainer.classList.add('drawer-closed-adjacent');
                if (editSection) {
                    editSection.classList.remove('col-lg-6');
                    editSection.classList.add('col-lg-12');
                }
            }
        }

        // Update header icon (inside drawer)
        if (icon) {
            icon.classList.toggle('fa-chevron-right', !isOpen);
            icon.classList.toggle('fa-chevron-left', isOpen);
        }

        // Update floating button icon rotation
        if (drawerToggleIcon) {
            if (isOpen) {
                drawerToggleIcon.classList.add('drawer-open-icon');
            } else {
                drawerToggleIcon.classList.remove('drawer-open-icon');
            }
        }
    }
</script>
{% endblock %}



