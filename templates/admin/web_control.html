{% extends "admin/base.html" %}

{% block title %}Web Control{% endblock %}

{% block page_heading %}Web Control{% endblock %}

{% block extra_head %}
<!-- Frontend CSS for preview matching -->
<link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="{{ url_for('static', filename='src/css/bootstrap.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='src/css/styles.css') }}" />
<!-- Shared Quill Preview Match CSS - Ensures editor preview matches frontend exactly -->
<link rel="stylesheet" href="{{ url_for('static', filename='src/css/quill-preview-match.css') }}" />
<style>
    /* Admin-specific styles (not related to Quill preview matching) */
    .card-body {
        padding: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    /* Better spacing for existing items */
    .list-group-item {
        transition: background-color 0.2s ease;
    }
    
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    /* Button improvements */
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
    
    /* Card header improvements */
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    
    /* Form input improvements */
    .form-control {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* Gap utility for flex items */
    .gap-2 {
        gap: 0.5rem;
    }

    /* ===============================
       Right Sidebar Drawer for Existing Items
       =============================== */
    #existingItemsSection {
        position: fixed;
        top: 80px; /* below topbar */
        right: 0;
        width: 420px;
        max-width: 100%;
        height: calc(100vh - 90px);
        z-index: 1040;
        transform: translateX(100%);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: none;
        pointer-events: none; /* prevent clicks when hidden */
    }

    #existingItemsSection.drawer-open {
        transform: translateX(0);
        box-shadow: -4px 0 16px rgba(0, 0, 0, 0.15);
        pointer-events: auto;
    }

    /* Make card take full height inside drawer */
    #existingItemsSection .card {
        height: 100%;
        border-radius: 0;
        border-left: 1px solid #e5e7eb;
    }

    #existingItemsSection .card-body {
        height: calc(100% - 56px); /* account for card-header */
    }

    /* Floating toggle button on right edge */
    .drawer-toggle-btn {
        position: fixed;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        z-index: 1050;
        border-radius: 30px 0 0 30px;
        box-shadow: -2px 2px 8px rgba(0,0,0,0.2);
        padding: 0.5rem 0.75rem;
    }

    .drawer-toggle-btn i {
        transition: transform 0.3s ease;
    }

    .drawer-open-icon {
        transform: rotate(180deg);
    }

    /* Edit section width adjustment based on drawer state */
    #editSection {
        transition: all 0.3s ease;
    }
    
    /* When drawer is open, edit section width = 100% - drawer width (420px) */
    .drawer-open-adjacent #editSection {
        flex: 0 0 calc(100% - 420px);
        max-width: calc(100% - 420px);
        padding-right: 0 !important;
        margin-right: 0 !important;
    }
    
    /* When drawer is closed, edit section is full width */
    .drawer-closed-adjacent #editSection {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    /* Remove gap between edit section and drawer */
    .drawer-open-adjacent {
        margin-right: 0;
        padding-right: 0;
    }
    
    /* Remove Bootstrap gutter on right side when drawer is open */
    .drawer-open-adjacent > * {
        padding-right: 0;
    }
    
    /* Remove container padding on right when drawer is open */
    .container-fluid:has(.drawer-open-adjacent),
    .container:has(.drawer-open-adjacent) {
        padding-right: 0;
    }
    
    /* Fallback for browsers without :has() support */
    .drawer-open-adjacent {
        margin-right: 0 !important;
    }
    
    /* Ensure edit section card extends to edge */
    .drawer-open-adjacent #editSection .card {
        margin-right: 0;
        border-radius: 0.375rem 0 0 0.375rem;
    }
    
    /* Ensure drawer aligns perfectly with edit section - no gap */
    #existingItemsSection.drawer-open {
        right: 0;
    }
    
    /* Remove any spacing that might create gap */
    .drawer-open-adjacent #editSection {
        margin-right: 0 !important;
    }

    @media (max-width: 767.98px) {
        #existingItemsSection {
            width: 100%;
            top: 70px;
            height: calc(100vh - 80px);
        }
        
        /* On mobile, edit section is always full width when drawer is open */
        .drawer-open-adjacent #editSection {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="row drawer-open-adjacent">
    <div class="col-lg-6" id="editSection">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-edit"></i> Add/Edit Navigation & Content
                </h6>
            </div>
            <div class="card-body">
                <form action="{{ url_for('admin_web_control_save') }}" method="POST" id="mainForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="nav_key_old" id="nav_key_old" value=""/>
                    <input type="hidden" name="content" id="quillContent"/>
                    
                    <div class="form-group">
                        <label for="nav_name">Nav Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nav_name" name="nav_name" 
                               placeholder="e.g., about, home, services" required>
                        <small class="form-text text-muted">Unique identifier (lowercase, no spaces)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="nav_label">Label <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nav_label" name="nav_label" 
                               placeholder="e.g., About, Home, Services" required>
                    </div>
                    
                    <div class="form-group">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="mb-0">Section Content <span class="text-danger">*</span></label>
                            <div class="d-flex align-items-center">
                                <!-- Quick text color buttons -->
                                <div class="btn-group mr-2" role="group" aria-label="Quick text colors">
                                    <button type="button" class="btn btn-sm btn-light border" 
                                            title="Primary blue text"
                                            onclick="setQuillTextColor('#2f557f')">
                                        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background-color:#2f557f;"></span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-light border" 
                                            title="Danger red text"
                                            onclick="setQuillTextColor('#dc3545')">
                                        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background-color:#dc3545;"></span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-light border" 
                                            title="Reset text color"
                                            onclick="setQuillTextColor(false)">
                                        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,#000 0,#000 45%,transparent 45%,transparent 55%,#000 55%,#000 100%);"></span>
                                    </button>
                                </div>
                                <!-- Template loader -->
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="loadTemplateBtn" 
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                            title="Load Template">
                                        <i class="fas fa-file-alt"></i> Load Template
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right" id="templateDropdown" aria-labelledby="loadTemplateBtn">
                                        <h6 class="dropdown-header">Select a Template</h6>
                                        <div id="templateList">
                                            <div class="dropdown-item-text text-muted">Loading templates...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="quillEditor"></div>
                        <small class="form-text text-muted mt-2">Use the editor above to format your content with HTML.</small>
                    </div>

                    <div class="form-group mt-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableMapsPlugin" onchange="toggleMapsForm()">
                            <label class="form-check-label" for="enableMapsPlugin">
                                <i class="fas fa-map-marker-alt"></i> <strong>Add Google Maps Plugin</strong>
                            </label>
                            <small class="form-text text-muted d-block">Check this to add a Google Maps to this section</small>
                        </div>
                    </div>

                    <div class="card mt-3" id="mapsPluginCard" style="display: none;">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-map-marker-alt"></i> Google Maps Plugin
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="map_latitude">Latitude</label>
                                <input type="number" step="any" class="form-control" id="map_latitude" name="map_latitude" 
                                       placeholder="e.g., -6.2088">
                                <small class="form-text text-muted">Enter latitude coordinate (e.g., -6.2088 for Jakarta)</small>
                            </div>
                            <div class="form-group">
                                <label for="map_longitude">Longitude</label>
                                <input type="number" step="any" class="form-control" id="map_longitude" name="map_longitude" 
                                       placeholder="e.g., 106.8456">
                                <small class="form-text text-muted">Enter longitude coordinate (e.g., 106.8456 for Jakarta)</small>
                            </div>
                            <div class="form-group">
                                <div id="mapPreview" style="height: 300px; border: 1px solid #ddd; border-radius: 4px; display: none;"></div>
                                <small class="form-text text-muted">Map preview will appear when both coordinates are entered.</small>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <i class="fas fa-times"></i> Clear Form
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Right sidebar drawer: Existing items (open by default) -->
    <div class="col-lg-5 drawer-open" id="existingItemsSection">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-link text-primary p-0 mr-2" 
                            id="toggleExistingItems" title="Toggle Existing Items"
                            onclick="toggleExistingItemsSection()">
                        <i class="fas fa-chevron-right" id="toggleExistingItemsIcon"></i>
                    </button>
                    <h6 class="m-0 font-weight-bold text-primary" id="existingItemsTitle">
                        <i class="fas fa-list"></i> Existing Items
                    </h6>
                </div>
                <button type="button" class="btn btn-sm btn-success" id="addNewBtn" onclick="addNewSection()" title="Add New Section">
                    <i class="fas fa-plus"></i> Add New
                </button>
            </div>
            <div id="existingItemsContent">
            <div class="card-body" style="max-height: 800px; overflow-y: auto;">
                {% if navigation %}
                    <div class="list-group list-group-flush">
                        {% for nav in navigation %}
                        <div class="list-group-item px-0 py-3 border-bottom">
                            <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1 font-weight-bold">{{ nav.label }}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-tag"></i> {{ nav.key }}
                                    </small>
                                </div>
                            </div>
                            <div class="d-flex gap-2 mt-2">
                                <button type="button" class="btn btn-sm btn-warning edit-item-btn flex-fill" 
                                        data-key="{{ nav.key }}"
                                        data-label="{{ nav.label }}"
                                        title="Edit">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <form action="{{ url_for('admin_web_control_delete_nav', nav_key=nav.key) }}" 
                                      method="POST" style="display: inline; flex: 1;" 
                                      class="delete-form"
                                      data-label="{{ nav.label }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-sm btn-danger w-100" title="Delete">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No items yet. Click "Add" to create a new section.</p>
                {% endif %}
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating toggle button for right sidebar drawer -->
<button type="button"
        class="btn btn-primary drawer-toggle-btn"
        id="drawerToggleButton"
        title="Toggle Existing Items"
        onclick="toggleExistingItemsSection()">
    <i class="fas fa-list" id="drawerToggleIcon"></i>
</button>

{% endblock %}

{% block extra_scripts %}
<!-- Quill Editor -->
<link href="{{ url_for('static', filename='lib/quill/quill.snow.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='lib/quill/quill.min.js') }}"></script>
<!-- Quill Image Resize Module -->
<script src="https://unpkg.com/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

<script type="application/json" id="content-data">
{{ content_data|tojson|safe }}
</script>

<script type="application/json" id="navigation-data">
{{ navigation|tojson|safe }}
</script>

<script type="application/json" id="plugin-data">
{{ plugin_data|tojson|safe }}
</script>

<script>
    let quill = null;
    let contentData = {};
    let navigationData = [];
    let pluginData = {};

    // Load content data from server
    try {
        const dataScript = document.getElementById('content-data');
        if (dataScript && dataScript.textContent) {
            contentData = JSON.parse(dataScript.textContent);
        }
    } catch (e) {
        console.error('Error loading content data:', e);
        contentData = {};
    }

    // Load navigation data from server
    try {
        const navScript = document.getElementById('navigation-data');
        if (navScript && navScript.textContent) {
            navigationData = JSON.parse(navScript.textContent);
        }
    } catch (e) {
        console.error('Error loading navigation data:', e);
        navigationData = [];
    }

    // Load plugin data from server
    try {
        const pluginScript = document.getElementById('plugin-data');
        if (pluginScript && pluginScript.textContent) {
            pluginData = JSON.parse(pluginScript.textContent);
        }
    } catch (e) {
        console.error('Error loading plugin data:', e);
        pluginData = {};
    }

    function editItem(key, label) {
        document.getElementById('nav_name').value = key;
        document.getElementById('nav_label').value = label;
        document.getElementById('nav_key_old').value = key;
        
        // Load content into Quill editor using the clipboard API
        // This is the supported way and avoids breaking Quill's internal state
        if (quill) {
            if (contentData[key]) {
                // Clear editor first
                quill.setContents([{ insert: '\n' }], 'silent');
                
                // Use clipboard API to import HTML content
                // Quill will convert it into its internal Delta format safely
                quill.clipboard.dangerouslyPasteHTML(0, contentData[key]);
            } else {
                quill.setContents([{ insert: '\n' }], 'silent');
            }
        }
        
        // Load map data from plugin structure first, then fallback to navigation
        let mapLat = '';
        let mapLng = '';
        
        // Check plugin data first (from site_content.json)
        if (pluginData[key] && pluginData[key].maps) {
            const mapsPlugin = pluginData[key].maps;
            if (mapsPlugin.latitude && mapsPlugin.longitude) {
                mapLat = mapsPlugin.latitude;
                mapLng = mapsPlugin.longitude;
            }
        }
        
        // Fallback to navigation data if plugin doesn't have it
        if (!mapLat && !mapLng) {
            const navItem = navigationData.find(nav => nav.key === key);
            if (navItem && navItem.map_latitude && navItem.map_longitude) {
                mapLat = navItem.map_latitude;
                mapLng = navItem.map_longitude;
            }
        }
        
        // Set map fields and show/hide maps form
        if (mapLat && mapLng) {
            document.getElementById('enableMapsPlugin').checked = true;
            document.getElementById('mapsPluginCard').style.display = 'block';
            document.getElementById('map_latitude').value = mapLat;
            document.getElementById('map_longitude').value = mapLng;
            updateMapPreview();
        } else {
            document.getElementById('enableMapsPlugin').checked = false;
            document.getElementById('mapsPluginCard').style.display = 'none';
            document.getElementById('map_latitude').value = '';
            document.getElementById('map_longitude').value = '';
            document.getElementById('mapPreview').style.display = 'none';
        }
        
        // Scroll to form
        document.getElementById('mainForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function clearForm() {
        document.getElementById('mainForm').reset();
        document.getElementById('nav_key_old').value = '';
        if (quill) {
            quill.setContents([{ insert: '\n' }], 'silent');
        }
        document.getElementById('mapPreview').style.display = 'none';
        document.getElementById('enableMapsPlugin').checked = false;
        document.getElementById('mapsPluginCard').style.display = 'none';
    }

    function toggleMapsForm() {
        const checkbox = document.getElementById('enableMapsPlugin');
        const mapsCard = document.getElementById('mapsPluginCard');
        
        if (checkbox.checked) {
            mapsCard.style.display = 'block';
        } else {
            mapsCard.style.display = 'none';
            // Clear map fields when disabled
            document.getElementById('map_latitude').value = '';
            document.getElementById('map_longitude').value = '';
            document.getElementById('mapPreview').style.display = 'none';
        }
    }

    function updateMapPreview() {
        const lat = parseFloat(document.getElementById('map_latitude').value);
        const lng = parseFloat(document.getElementById('map_longitude').value);
        const previewDiv = document.getElementById('mapPreview');
        
        if (!isNaN(lat) && !isNaN(lng)) {
            previewDiv.style.display = 'block';
            const embedUrl = `https://maps.google.com/maps?q=${lat},${lng}&hl=en&z=14&output=embed`;
            previewDiv.innerHTML = `<iframe src="${embedUrl}" width="100%" height="100%" style="border:0; border-radius:4px;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
        } else {
            previewDiv.style.display = 'none';
        }
    }

    function addNewSection() {
        clearForm();
        // Scroll to form
        document.getElementById('mainForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Focus on nav_name input
        setTimeout(function() {
            document.getElementById('nav_name').focus();
        }, 300);
    }

    // Quick helper to change selected text color in Quill
    function setQuillTextColor(color) {
        if (!quill) return;
        // color: hex string (e.g., '#2f557f') or false to reset
        quill.focus();
        quill.format('color', color || false);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Wait for ImageResize module to load
        function initQuill() {
            // Check if ImageResize is available (try different export formats)
            let ImageResizeModule = null;
            
            if (typeof ImageResize !== 'undefined') {
                // Try different export formats
                if (typeof ImageResize === 'function') {
                    ImageResizeModule = ImageResize;
                } else if (ImageResize.default && typeof ImageResize.default === 'function') {
                    ImageResizeModule = ImageResize.default;
                } else if (ImageResize.ImageResize && typeof ImageResize.ImageResize === 'function') {
                    ImageResizeModule = ImageResize.ImageResize;
                } else if (typeof ImageResize === 'object') {
                    ImageResizeModule = ImageResize;
                }
            }
            
            if (!ImageResizeModule) {
                console.log('Waiting for ImageResize module to load...');
                setTimeout(initQuill, 100);
                return;
            }
            
            // Register ImageResize module with Quill
            try {
                if (!Quill.imports['modules/imageResize']) {
                    Quill.register('modules/imageResize', ImageResizeModule, true);
                    console.log('ImageResize module registered successfully');
                }
            } catch (e) {
                console.error('Error registering ImageResize module:', e);
            }
            
            // Initialize Quill Editor
            const editorDiv = document.getElementById('quillEditor');
            if (editorDiv) {
                const modulesConfig = {
                    toolbar: [
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ],
                    clipboard: {
                        // Allow more HTML elements to be preserved
                        matchVisual: false
                    }
                };
                
                // Add imageResize module if available
                if (ImageResizeModule) {
                    modulesConfig.imageResize = {
                        parchment: Quill.import('parchment'),
                        modules: ['Resize', 'DisplaySize', 'Toolbar']
                    };
                }
                
                quill = new Quill('#quillEditor', {
                    theme: 'snow',
                    modules: modulesConfig,
                    formats: ['bold', 'italic', 'underline', 'strike', 'header', 'list', 'bullet', 'color', 'background', 'align', 'link', 'image', 'width', 'height']
                });

                // Handle form submit
                const mainForm = document.getElementById('mainForm');
                if (mainForm) {
                    mainForm.addEventListener('submit', function(e) {
                        const htmlContent = quill.root.innerHTML;
                        document.getElementById('quillContent').value = htmlContent;
                        
                        // Clear map fields if checkbox is unchecked
                        const enableMapsCheckbox = document.getElementById('enableMapsPlugin');
                        if (!enableMapsCheckbox.checked) {
                            document.getElementById('map_latitude').value = '';
                            document.getElementById('map_longitude').value = '';
                        }
                    });
                }
            }
        }
        
        // Start initialization
        initQuill();

        // Handle edit button clicks
        document.querySelectorAll('.edit-item-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                editItem(
                    this.getAttribute('data-key'),
                    this.getAttribute('data-label')
                );
            });
        });

        // Handle delete form submissions
        document.querySelectorAll('.delete-form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                const label = this.getAttribute('data-label');
                if (!confirm('Are you sure you want to delete "' + label + '"?')) {
                    e.preventDefault();
                    return false;
                }
            });
        });

        // Handle map coordinate changes
        document.getElementById('map_latitude').addEventListener('input', updateMapPreview);
        document.getElementById('map_longitude').addEventListener('input', updateMapPreview);

        // Load templates
        loadTemplates();
        
        // Initialize drawer state on page load (drawer is open by default)
        const existingSection = document.getElementById('existingItemsSection');
        const editSection = document.getElementById('editSection');
        const rowContainer = existingSection ? existingSection.closest('.row') : null;
        
        if (existingSection && existingSection.classList.contains('drawer-open')) {
            // Drawer is open - CSS calc() handles width automatically
            if (rowContainer) {
                rowContainer.classList.add('drawer-open-adjacent');
            }
            if (editSection) {
                // Remove Bootstrap column classes - CSS calc() handles width
                editSection.classList.remove('col-lg-12', 'col-lg-6');
            }
            
            // Set initial icon states
            const icon = document.getElementById('toggleExistingItemsIcon');
            if (icon) {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
            
            const drawerToggleIcon = document.getElementById('drawerToggleIcon');
            if (drawerToggleIcon) {
                drawerToggleIcon.classList.add('drawer-open-icon');
            }
        }
    });
    
    // Load templates from server
    function loadTemplates() {
        fetch('{{ url_for("admin_web_control_templates") }}')
            .then(response => response.json())
            .then(templates => {
                const templateList = document.getElementById('templateList');
                templateList.innerHTML = '';
                
                if (Object.keys(templates).length === 0) {
                    templateList.innerHTML = '<div class="dropdown-item-text text-muted">No templates available</div>';
                    return;
                }
                
                Object.keys(templates).forEach(key => {
                    const template = templates[key];
                    const item = document.createElement('a');
                    item.className = 'dropdown-item';
                    item.href = '#';
                    item.innerHTML = `
                        <div>
                            <strong>${template.label || template.name}</strong>
                            ${template.description ? '<small class="text-muted d-block">' + template.description + '</small>' : ''}
                        </div>
                    `;
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        applyTemplate(template);
                        // Close dropdown using jQuery (Bootstrap 4)
                        if (typeof $ !== 'undefined') {
                            $('.dropdown-menu').removeClass('show');
                            $('.dropdown-toggle').attr('aria-expanded', 'false');
                        }
                    });
                    templateList.appendChild(item);
                });
            })
            .catch(error => {
                console.error('Error loading templates:', error);
                document.getElementById('templateList').innerHTML = '<div class="dropdown-item-text text-danger">Error loading templates</div>';
            });
    }
    
    // Apply template to form
    function applyTemplate(template) {
        if (!template) return;
        
        // Fill nav_name if empty
        const navNameInput = document.getElementById('nav_name');
        if (!navNameInput.value.trim()) {
            navNameInput.value = template.name || '';
        }
        
        // Fill nav_label if empty
        const navLabelInput = document.getElementById('nav_label');
        if (!navLabelInput.value.trim()) {
            navLabelInput.value = template.label || template.name || '';
        }
        
        // Fill content in Quill editor
        if (quill && template.content) {
            quill.clipboard.dangerouslyPasteHTML(0, template.content);
        }
        
        // Handle map if template has map
        if (template.has_map) {
            document.getElementById('enableMapsPlugin').checked = true;
            document.getElementById('mapsPluginCard').style.display = 'block';
            // Don't auto-fill coordinates, let user enter them
        }
        
        // Show success message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
            Template "${template.label || template.name}" loaded successfully!
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;
        const form = document.getElementById('mainForm');
        form.insertBefore(alertDiv, form.firstChild);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
        
        // Scroll to form
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Toggle existing items drawer (right sidebar)
    function toggleExistingItemsSection() {
        const existingSection = document.getElementById('existingItemsSection');
        const editSection = document.getElementById('editSection');
        const rowContainer = existingSection ? existingSection.closest('.row') : null;
        const icon = document.getElementById('toggleExistingItemsIcon');
        const drawerToggleIcon = document.getElementById('drawerToggleIcon');

        if (!existingSection) return;

        const isOpen = existingSection.classList.toggle('drawer-open');

        // Adjust edit section width based on drawer state
        if (rowContainer) {
            if (isOpen) {
                // Drawer is open - edit section uses calc(100% - 420px) via CSS
                rowContainer.classList.remove('drawer-closed-adjacent');
                rowContainer.classList.add('drawer-open-adjacent');
                if (editSection) {
                    // Remove Bootstrap column classes - CSS calc() handles width
                    editSection.classList.remove('col-lg-12', 'col-lg-6');
                }
            } else {
                // Drawer is closed - make edit section full width
                rowContainer.classList.remove('drawer-open-adjacent');
                rowContainer.classList.add('drawer-closed-adjacent');
                if (editSection) {
                    editSection.classList.remove('col-lg-6');
                    editSection.classList.add('col-lg-12');
                }
            }
        }

        // Update header icon (inside drawer)
        if (icon) {
            icon.classList.toggle('fa-chevron-right', !isOpen);
            icon.classList.toggle('fa-chevron-left', isOpen);
        }

        // Update floating button icon rotation
        if (drawerToggleIcon) {
            if (isOpen) {
                drawerToggleIcon.classList.add('drawer-open-icon');
            } else {
                drawerToggleIcon.classList.remove('drawer-open-icon');
            }
        }
    }
</script>
{% endblock %}

